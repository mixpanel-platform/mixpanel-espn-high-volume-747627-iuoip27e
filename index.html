<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="pageViewsChart"></div>
    <div class="pageViewsTable"></div>
    <div class="slotViewsChart"></div>
    <div class="slotViewsTable"></div>
    <script>
      var pageViewParams = {
        where: '(properties["Edition Name"] == "English / United States") and (properties["Referring Page"] != "Home Page") and defined (properties["Referring Page"])',
        on: 'properties["Referring Page"]',
        to_date: new Date().toISOString().split('T')[0],
        from_date: new Date(new Date() - 60 * 60 * 1000 * 24).toISOString().split('T')[0],
        unit: "hour"
      }
      MP.api.segment('Page View', pageViewParams).done(function(data){
        var $chart = $('.pageViewsChart').MPChart({
          highchartsOptions: {
            xAxis: {
              type: 'datetime',
              tickInterval: 36e5,
              labels: {
                formatter: function () {
                  debugger
                    return '<a href="' + categoryLinks[this.value] + '">' +
                        this.value + '</a>';
                }
              }
            },
          },
          chartType: 'line',
          data: data
        })
        // var $table = $('.pageViewsTable').appendTo('.pageViewsContainer').MPTable({
        //   data: data.json
        // })
      })
      
      var multiSegParams = {
          event:"Page View",
          type:"unique",
          where:'defined (properties["Referrer Slot"]) and (properties["Referring Page"] == "Home Page") and (properties["Edition Name"] == "English / United States") and defined (properties["Story Headline"])',
          limit:25,
          inner:'properties["Referrer Position"]',
          outer:'properties["Referrer Slot"]',
          outer_modifier:'numeric',
          inner_modifier:'numeric',
          to_date:'2016-10-24',
          from_date:'2016-10-19',
          unit:'hour',
          buckets:12,
          allow_more_buckets:false
      }
      var $multiseg = MP.api.query('api/2.0/segmentation/multiseg', multiSegParams)
      $multiseg.done(function(data){
        debugger
        var res = {}
        _.each(data.data.values, function(innerVals, outer){
          _.each(innerVals, function(dates, inner){
            res["Slot " +String(outer) + '/Position ' + String(inner)] = dates
          })
        })
         var $chart = $('.slotViewsChart').MPChart({
          chartType: 'line',
          data: res
        })
        // var $table = $('.slotViewsTable').MPTable({
        //   data: data.data
        // })
      });
      //MP.api.jql
      // Multiseg
      //var HomePageViews = MP.api.query
    </script>
  </body>
</html>
