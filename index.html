<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="pageViewsChart"></div>
    <div class="pageViewsTable"></div>
    <div class="slotViewsChart"></div>
    <div class="slotViewsTable"></div>
    <script>
      //can i do this in one request per table graph combo?
      
      /* index page views */
      
      var pageViewIndex = {
        where: '(properties["Edition Name"] == "English / United States") and (properties["Referring Page"] != "Home Page") and defined (properties["Referring Page"])',
        on: 'properties["Referring Page"]',
        to_date: new Date().toISOString().split('T')[0],
        from_date: new Date(new Date() - 60 * 60 * 1000 * 24 * 7).toISOString().split('T')[0],
        unit: "hour"
      }
      
      var $pastPageViewsIndexData = MP.api.segment('Page View', pageViewGraphParams)
      
      $pastPageViewsIndexData.done(function(data){
        var graphData = {}
        var tableData = {}
        _.each(data.json, function(dateObjs, series ){
          /* Seems redundant to do this twice? */
          
          graphData[k] = _.pick(dateObjs, function(v,date) { 
            return new Date(date) > new Date() - (1000 * 60 * 60 * 8)
          })
          tableData[k] = _.pick(dateObjs, function(v,date){
            // test that we are this hour, yesterday same hour, or last week same hour
            var hourString = new Date(date).toISOString().split(':') 
            var currHour = new Date().toISOString.split(':')
            var lastDay = new Date(new Date() - (1000 * 60 * 60 * 24)).toISOString.split(':') 
            var lastWeek = new Date(new Date() - (1000 * 60 * 60 * 24 * 7)).toISOString.split(':') 
            return 
                  hourString == currHour ||
                  hourString == lastWeek ||
                  hourString == lastDay
          })
          debugger
        })
        var $chart = $('.pageViewsChart').MPChart({
          highchartsOptions: {
            tooltip: {
                formatter: function () {
                  var dateObj = new Date(this.x)
                  var [day, mon, date, year, hour] = dateObj.toString().split(' ')
                  var response = [mon, date, hour].join(' ') + '<br/>' + this.series.name + ' ' + this.y
                  return response
                }
            },
            xAxis: {
              type: 'datetime',
              tickInterval: 36e5,
              labels: {
                formatter: function () {
                    var dateObj = new Date(this.value)
                    var [day, mon, date, year, hour] = dateObj.toString().split(' ')
                    return [mon, date, hour].join(' ')
                    
                }
              }
            },
          },
          chartType: 'line',
          data: graphData
        })
        // var $table = $('.pageViewsTable').appendTo('.pageViewsContainer').MPTable({
        //   data: data.json
        // })
      })
      
      
      /* Slot by story */
      var multiSegParams = {
          event:"Page View",
          type:"unique",
          where:'defined (properties["Referrer Slot"]) and (properties["Referring Page"] == "Home Page") and (properties["Edition Name"] == "English / United States") and defined (properties["Story Headline"])',
          limit:25,
          inner:'properties["Story Headline"]',
          outer:'properties["Referrer Slot"]',
          outer_modifier:'numeric',
          inner_modifier:'numeric',
          to_date: new Date().toISOString().split('T')[0],
          from_date: new Date(new Date() - 60 * 60 * 1000 * 24).toISOString().split('T')[0],
          unit:'hour',
          buckets:12,
          allow_more_buckets:false
      }
      var $multiseg = MP.api.query('api/2.0/segmentation/multiseg', multiSegParams)
      $multiseg.done(function(data){
        var res = {}
        _.each(data.data.values, function(innerVals, outer){
          _.each(innerVals, function(dates, inner){
            res["Slot " +String(outer) + '/Position ' + String(inner)] = dates
          })
        })
         var $chart = $('.slotViewsChart').MPChart({
          highchartsOptions: {
            tooltip: {
                formatter: function () {
                  var dateObj = new Date(this.x)
                  var [day, mon, date, year, hour] = dateObj.toString().split(' ')
                  var response = [mon, date, hour].join(' ') + '<br/>' + this.series.name + ' ' + this.y
                  return response
                }
            },
            xAxis: {
              type: 'datetime',
              tickInterval: 36e5,
              labels: {
                formatter: function () {
                    var dateObj = new Date(this.value)
                    var [day, mon, date, year, hour] = dateObj.toString().split(' ')
                    return [mon, date, hour].join(' ')
                    
                }
              }
            },
          },
          chartType: 'line',
          data: res
        })
        // var $table = $('.slotViewsTable').MPTable({
        //   data: data.data
        // })
      });
      //MP.api.jql
      // Multiseg
      //var HomePageViews = MP.api.query
    </script>
  </body>
</html>
