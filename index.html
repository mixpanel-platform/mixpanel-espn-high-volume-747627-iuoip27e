<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="pageViewsSlotChart"></div>
    <table id="table" class="display pageViewsSlotTable" width="100%"></table>
    <div class="pageViewsIndexChart"></div>
    <table id="table" class="display pageViewsIndexTable" width="100%"></table>
    <div class="slotStoryViewsChart"></div>
    <table id="table" class="display slotStoryViewsTable" width="100%"></table>
    <script id='multiseg'>
      function main() {
        return Events({
          from_date: params.from,
          to_date:   params.to,
          event_selectors: [{event: 'Page View', selector:'defined (properties["Referrer Slot"]) and defined (properties["Referrer Position"]) and (properties["Edition Name"] == "English / United States") and defined (properties["Story Headline"])'}]
        })
        .filter(function(event){ return today(event) || yesterdayHour(event) || weekHour(event)})
        .groupBy([stringSlot, "properties.Referrer Position"], function(accs, events){
          var res = {}
          _.each(events, function(event){
            var timeStr = [new Date(event.time).toISOString().split(':')[0],'00','00'].join(':')
            res[timeStr] = res[timeStr] + 1 || 1
            if (event.time > res.last || !res.last){
              res.story = event.properties["Story Headline"]
              res.last = event.time
            }
          })
          _.each(accs, function(acc){
            
            _.each(acc, function(v, k){
              if (k == 'story' || k =='last'){
                if (acc.last > res.last || !res.last) {
                  res.story = acc.story
                  res.last = acc.last
                }
              } else {
                res[k] = res[k] + v || v
              } 
            })
          })
          return res
        })
        .map(function(item){
          var res = {
            slot: item.key[0],
            position: item.key[1],
            story: item.value.story,
            value: _.omit(item.value, ['story', 'last'])
          }
          return res
        })
      }
      function stringSlot(event){
        return String(event.properties["Referrer Slot"])
      }
      function today(event){
        return new Date().toISOString().split('T')[0] == new Date(event.time).toISOString().split('T')[0]
      }
      
      function yesterdayHour(event){
        return new Date(new Date() - 1000 * 60 * 60 * 24).toISOString().split(':')[0] == new Date(event.time).toISOString().split(':')[0]
      }
      
      function weekHour(event){
        return new Date(new Date() - 1000 * 60 * 60 * 24 * 7).toISOString().split(':')[0] == new Date(event.time).toISOString().split(':')[0]
      }
    </script>
    <script>
      // Use Data tables for better sorting/limiting etc
       /* slot page views */
       
       var highChartsConfig = {
            tooltip: {
                formatter: function () {
                  var dateObj = new Date(this.x)
                  var [day, mon, date, year, hour] = dateObj.toString().split(' ')
                  var response = [mon, date, hour].join(' ') + '<br/>' + this.series.name + ' ' + this.y
                  return response
                }
            },
            xAxis: {
              type: 'datetime',
              tickInterval: 36e5,
              labels: {
                formatter: function () {
                    var dateObj = new Date(this.value)
                    var [day, mon, date, year, hour] = dateObj.toString().split(' ')
                    return [mon, date, hour].join(' ')
                    
                }
              }
            },
          }
      
      var pageViewSlotParams = {
        where: 'defined (properties["Referrer Slot"]) and (properties["Referring Page"] == "Home Page") and (properties["Edition Name"] == "English / United States") and defined (properties["Story Headline"])',
        on: 'properties["Referrer Slot"]',
        to_date: new Date().toISOString().split('T')[0],
        from_date: new Date(new Date() - 60 * 60 * 1000 * 24 * 7).toISOString().split('T')[0],
        unit: "hour"
      }
      
      var $pastPageViewsSlot = MP.api.segment('Page View', pageViewSlotParams)
      
      $pastPageViewsSlot.done(function(data){
        var graphData = {}
        var tableData = {}
        _.each(data.json, function(dateObjs, series){
         [graphData[series], tableData[series]] = filterData(dateObjs)
        })
        var $chart = $('.pageViewsSlotChart').MPChart({
          highchartsOptions: highChartsConfig,
          chartType: 'line',
          data: graphData
        })
        $('.pageViewsSlotTable').DataTable( {
            columns: [
                { title: 'Slot', data: 'name' },
                { title: 'Current Hour', data: 'Current Hour' },
                { title: '24 Hours Ago', data: '24 Hours Ago'},
                { title: 'Last Week', data: 'Last Week' },
            ]
        });
        var table = $('.pageViewsSlotTable').DataTable().clear()
        _.each(tableData, function(vals, slot){
          var row = _.extend({'name': slot}, vals)
          table.row.add(row)
        })
       table.draw();
      })
      
      
      /* index page views */
      
      var pageViewIndexParams = {
        where: '(properties["Edition Name"] == "English / United States") and (properties["Referring Page"] != "Home Page") and defined (properties["Referring Page"])',
        on: 'properties["Referring Page"]',
        to_date: new Date().toISOString().split('T')[0],
        from_date: new Date(new Date() - 60 * 60 * 1000 * 24 * 7).toISOString().split('T')[0],
        unit: "hour"
      }
      
      var $pastPageViewsIndexData = MP.api.segment('Page View', pageViewIndexParams)
      
      $pastPageViewsIndexData.done(function(data){
        var graphData = {}
        var tableData = {}
        _.each(data.json, function(dateObjs, series ){
         [graphData[series], tableData[series]] = filterData(dateObjs)
        })
        var $chart = $('.pageViewsIndexChart').MPChart({
          highchartsOptions: highChartsConfig,
          chartType: 'line',
          data: graphData
        })
        $('.pageViewsIndexTable').DataTable( {
            columns: [
                { title: 'Index', data: 'name' },
                { title: 'Current Hour', data: 'Current Hour'},
                { title: '24 Hours Ago', data: '24 Hours Ago'},
                { title: 'Last Week', data: 'Last Week' },
            ]
        });
        var table = $('.pageViewsIndexTable').DataTable().clear()
        _.each(tableData, function(vals, index){
          var row = _.extend({'name': index}, vals)
          table.row.add(row)
        })
       table.draw();
      })
      // rewrite multiseg as jql
      
      /* Slot by story */
      var multiSegParams = {
          event:"Page View",
          type:"unique",
          where:'defined (properties["Referrer Slot"]) and (properties["Referring Page"] == "Home Page") and (properties["Edition Name"] == "English / United States") and defined (properties["Story Headline"])',
          limit:25,
          inner:'properties["Story Headline"]',
          outer:'properties["Referrer Slot"]',
          outer_modifier:'numeric',
          inner_modifier:'numeric',
          to_date: new Date().toISOString().split('T')[0],
          from_date: new Date(new Date() - 60 * 60 * 1000 * 24 * 7).toISOString().split('T')[0],
          unit:'hour',
          buckets:12,
          allow_more_buckets:false
      }
      var jqlParams = {
        to: new Date().toISOString().split('T')[0],
        from: new Date(new Date() - 60 * 60 * 1000 * 24 * 7).toISOString().split('T')[0],
      }
      var query = $('#multiseg').html()
      MP.api.jql(query,jqlParams).done(function(data){
      // can i make the three request for today, 24hr ago, and last week
      // var $multiseg = MP.api.query('api/2.0/segmentation/multiseg', multiSegParams)
      // $multiseg.done(function(data){
        var graphData = {}
        var tableData = {}
        var seriesStr
        debugger
        _.each(data, function(obj){
          series = ["Slot ", String(obj.slot),":Position ",String(obj.position), ":Story ", String(obj.story)].join('')
          [graphData[series], tableData[series]] = filterData(obj.val)
        })
        var $chart = $('.slotStoryViewsChart').MPChart({
          highchartsOptions: highChartsConfig,
          chartType: 'line',
          data: graphData
        })
        $('.slotStoryViewsTable').DataTable( {
            columns: [
                { title: 'Slot Story', data: 'name' },
                { title: 'Current Hour', data: 'Current Hour' },
                { title: '24 Hours Ago', data: '24 Hours Ago'},
                { title: 'Last Week', data: 'Last Week' },
            ]
        });
        var table = $('.slotStoryViewsTable').DataTable().clear()
        _.each(tableData, function(vals, index){
          var row = _.extend({'name': index}, vals)
          table.row.add(row)
        })
      table.draw();
      });
      
      var filterData = function(dateObjs){
        var graphData = _.pick(dateObjs, function(v,date) { 
          if (new Date(date) > new Date() - (1000 * 60 * 60 * 8) && new Date(date) < new Date()){
            return true
          }
        })  
        // not super useful needs to be condensed/ combine compared to average of slot 1 of last
        // just access the three I need instead of checking (constant time vs N time)
        var dateObj = new Date()
        var currHour = dateObj.getFullYear() + '-' + (dateObj.getMonth() + 1) + '-' + dateObj.getDate() + ' ' + dateObj.getHours() + ':00:00'
        var lastDateObj = new Date(new Date() - (1000 * 60 * 60 * 24))
        var lastDay = lastDateObj.getFullYear() + '-' + (lastDateObj.getMonth() + 1) + '-' + lastDateObj.getDate() + ' ' + lastDateObj.getHours() + ':00:00'
        var lastWkObj = new Date(new Date() - (1000 * 60 * 60 * 24 * 7))
        var lastWeek = lastWkObj.getFullYear() + '-' + (lastWkObj.getMonth() + 1) + '-' + lastWkObj.getDate() + ' ' + lastWkObj.getHours() + ':00:00'
        var tableData = {
          'Current Hour': dateObjs[currHour], 
          '24 Hours Ago': dateObjs[lastDay], 
          'Last Week': dateObjs[lastWeek]
        }

        return [graphData, tableData]
      }
    </script>
  </body>
</html>
